import requests
import pandas as pd
import sqlite3

def fetch_covid_data(country='us'):
    url = f"https://api.covid19api.com/dayone/country/{country}"
    response = requests.get(url)
    data = response.json()
    df = pd.DataFrame(data)
    return df

def transform_data(df):
    df = df[['Date', 'Confirmed', 'Deaths', 'Recovered', 'Active']]
    df['Date'] = pd.to_datetime(df['Date']).dt.date
    df = df.drop_duplicates(subset=['Date'])
    df = df.sort_values('Date')
    df['NewConfirmed'] = df['Confirmed'].diff().fillna(0)
    df['7DayAvgNewConfirmed'] = df['NewConfirmed'].rolling(window=7).mean().fillna(0)
    return df

def load_to_db(df, db_name='covid_data.db', table_name='us_covid'):
    conn = sqlite3.connect(db_name)
    df.to_sql(table_name, conn, if_exists='replace', index=False)
    conn.close()

if __name__ == "__main__":
    df_raw = fetch_covid_data('us')
    df_transformed = transform_data(df_raw)
    load_to_db(df_transformed)
    print("Pipeline complete: data loaded to SQLite database.")
